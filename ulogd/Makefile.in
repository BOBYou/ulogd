#

include @top_srcdir@/Rules.make
CFLAGS+=-I@top_srcdir@/libipulog/include -I@top_srcdir@/include

SUBDIRS=conffile libipulog extensions doc

ifeq (x@MYSQLINCLUDES@,x)
else
SUBDIRS+=mysql
endif

ifeq (x@PGSQLINCLUDES@,x)
else
SUBDIRS+=pgsql
endif

ifeq (x@HAVE_PCAP_H@,x)
else
SUBDIRS+=pcap
endif

#  Normally You should not need to change anything below

all: recurse ulogd

distrib:
	@for d in $(SUBDIRS); do if ! make -C $$d distrib; then exit 1; fi; done
	@make distclean

recurse: 
	@for d in $(SUBDIRS); do if ! make -C $$d; then exit 1; fi; done

ulogd: ulogd.c $(LIBIPULOG) include/ulogd/ulogd.h conffile/conffile.o $(LIBIPULOG)/libipulog.a ulogd.conf
	$(CC) $(CFLAGS) -rdynamic $< conffile/conffile.o $(LIBIPULOG)/libipulog.a -o $@ $(LIBS)

edit = sed -e 's,@libdir\@,$(ULOGD_LIB_PATH),g'

ulogd.conf: ulogd.conf.in
	$(edit) ulogd.conf.in > ulogd.conf

clean:
#	rm -f ulogd *.o extensions/*.o extensions/*.so conffile/*.o
	rm -f ulogd ulogd.o ulogd.conf
	@for d in $(SUBDIRS); do if ! make -C $$d $@; then exit 1; fi; done

distclean: clean
	@for d in $(SUBDIRS); do if ! make -C $$d $@; then exit 1; fi; done
	rm -f Makefile config.cache config.log config.status Rules.make

install: all
	@for d in $(SUBDIRS); do if ! make -C $$d $@; then exit 1; fi; done
	@[ -d $(DESTDIR)@sbindir@ ] || mkdir -p $(DESTDIR)@sbindir@
	@INSTALL@ -D -m 755 ulogd $(DESTDIR)@sbindir@/ulogd
	@[ -d $(DESTDIR)@sysconfdir@ ] || mkdir -p $(DESTDIR)@sysconfdir@
	@INSTALL@ -D -m 600 ulogd.conf $(DESTDIR)@sysconfdir@/ulogd.conf
	
doc:
	$(MAKE) -C $@
